<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransactionServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">WalletApp</a> &gt; <a href="index.source.html" class="el_package">com.example.WalletApp.service.impl</a> &gt; <span class="el_source">TransactionServiceImpl.java</span></div><h1>TransactionServiceImpl.java</h1><pre class="source lang-java linenums">package com.example.WalletApp.service.impl;

import com.example.WalletApp.dto.TransactionDTO;
import com.example.WalletApp.entity.*;
import com.example.WalletApp.repository.*;
import com.example.WalletApp.service.TransactionService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;
import java.util.Optional;

@Service
@Transactional
<span class="fc" id="L19">public class TransactionServiceImpl implements TransactionService {</span>
    
    @Autowired
    private TransactionRepository transactionRepository;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private WalletRepository walletRepository;
    
    @Autowired
    private CategoryRepository categoryRepository;
    
    @Override
    public Transaction createTransaction(Transaction transaction) {
        // Update wallet balance when creating transaction
<span class="fc" id="L36">        transaction.updateWalletBalance();</span>
<span class="fc" id="L37">        return transactionRepository.save(transaction);</span>
    }
    
    @Override
    public Transaction updateTransaction(Long id, Transaction transaction) {
<span class="fc" id="L42">        Transaction existingTransaction = transactionRepository.findById(id)</span>
<span class="fc" id="L43">            .orElseThrow(() -&gt; new RuntimeException(&quot;Transaction not found with id: &quot; + id));</span>
        
        // Revert old transaction's effect on wallet
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">        if (existingTransaction.getWallet() != null) {</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">            if (existingTransaction.isIncome()) {</span>
<span class="nc" id="L48">                existingTransaction.getWallet().updateBalance(existingTransaction.getAmount().negate());</span>
            } else {
<span class="fc" id="L50">                existingTransaction.getWallet().updateBalance(existingTransaction.getAmount());</span>
            }
        }
        
        // Update transaction fields
<span class="fc" id="L55">        existingTransaction.setName(transaction.getName());</span>
<span class="fc" id="L56">        existingTransaction.setAmount(transaction.getAmount());</span>
<span class="fc" id="L57">        existingTransaction.setType(transaction.getType());</span>
<span class="fc" id="L58">        existingTransaction.setCategory(transaction.getCategory());</span>
<span class="fc" id="L59">        existingTransaction.setRepeating(transaction.isRepeating());</span>
<span class="fc" id="L60">        existingTransaction.setFrequency(transaction.getFrequency());</span>
        
        // Apply new transaction's effect on wallet
<span class="fc" id="L63">        existingTransaction.updateWalletBalance();</span>
        
<span class="fc" id="L65">        return transactionRepository.save(existingTransaction);</span>
    }
    
    @Override
    public void deleteTransaction(Long id) {
<span class="fc" id="L70">        Transaction transaction = transactionRepository.findById(id)</span>
<span class="fc" id="L71">            .orElseThrow(() -&gt; new RuntimeException(&quot;Transaction not found with id: &quot; + id));</span>
        
        // Revert transaction's effect on wallet
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        if (transaction.getWallet() != null) {</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">            if (transaction.isIncome()) {</span>
<span class="nc" id="L76">                transaction.getWallet().updateBalance(transaction.getAmount().negate());</span>
            } else {
<span class="fc" id="L78">                transaction.getWallet().updateBalance(transaction.getAmount());</span>
            }
        }
        
<span class="fc" id="L82">        transactionRepository.deleteById(id);</span>
<span class="fc" id="L83">    }</span>
    
    @Override
    @Transactional(readOnly = true)
    public Optional&lt;Transaction&gt; getTransactionById(Long id) {
<span class="fc" id="L88">        return transactionRepository.findById(id);</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;Transaction&gt; getAllTransactions() {
<span class="nc" id="L94">        return transactionRepository.findAll();</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public Page&lt;Transaction&gt; getAllTransactions(Pageable pageable) {
<span class="nc" id="L100">        return transactionRepository.findAll(pageable);</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;Transaction&gt; getTransactionsByUserId(Long userId) {
<span class="fc" id="L106">        return transactionRepository.findByUserId(userId);</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;Transaction&gt; getTransactionsByWalletId(Long walletId) {
<span class="fc" id="L112">        return transactionRepository.findByWalletId(walletId);</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;Transaction&gt; getTransactionsByCategoryId(Long categoryId) {
<span class="fc" id="L118">        return transactionRepository.findByCategoryId(categoryId);</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;Transaction&gt; getTransactionsByType(String type) {
        try {
<span class="fc" id="L125">            TransactionType transactionType = TransactionType.valueOf(type.toUpperCase());</span>
<span class="fc" id="L126">            return transactionRepository.findByType(transactionType);</span>
<span class="fc" id="L127">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L128">            throw new RuntimeException(&quot;Invalid transaction type: &quot; + type);</span>
        }
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;Transaction&gt; getRepeatingTransactions() {
<span class="fc" id="L135">        return transactionRepository.findByRepeating(true);</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;Transaction&gt; getTransactionsByDateRange(Date startDate, Date endDate) {
<span class="fc" id="L141">        return transactionRepository.findByDateOfTransactionBetween(startDate, endDate);</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public List&lt;Transaction&gt; getTransactionsByUserAndDateRange(Long userId, Date startDate, Date endDate) {
<span class="fc" id="L147">        return transactionRepository.findByUserIdAndDateOfTransactionBetween(userId, startDate, endDate);</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public double getTotalIncomeByUserId(Long userId) {
<span class="fc" id="L153">        return transactionRepository.findByUserId(userId).stream()</span>
<span class="fc" id="L154">            .filter(Transaction::isIncome)</span>
<span class="fc" id="L155">            .mapToDouble(t -&gt; t.getAmount().doubleValue())</span>
<span class="fc" id="L156">            .sum();</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public double getTotalExpenseByUserId(Long userId) {
<span class="fc" id="L162">        return transactionRepository.findByUserId(userId).stream()</span>
<span class="fc" id="L163">            .filter(Transaction::isExpense)</span>
<span class="fc" id="L164">            .mapToDouble(t -&gt; t.getAmount().doubleValue())</span>
<span class="fc" id="L165">            .sum();</span>
    }
    
    @Override
    @Transactional(readOnly = true)
    public double getNetBalanceByUserId(Long userId) {
<span class="fc" id="L171">        return getTotalIncomeByUserId(userId) - getTotalExpenseByUserId(userId);</span>
    }
    
    @Override
    public TransactionDTO convertToDTO(Transaction transaction) {
<span class="fc" id="L176">        TransactionDTO dto = new TransactionDTO();</span>
<span class="fc" id="L177">        dto.setId(transaction.getId());</span>
<span class="fc" id="L178">        dto.setName(transaction.getName());</span>
<span class="fc" id="L179">        dto.setAmount(transaction.getAmount());</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        dto.setType(transaction.getType() != null ? transaction.getType().toString() : null);</span>
<span class="fc" id="L181">        dto.setDateOfTransaction(transaction.getDateOfTransaction());</span>
<span class="fc" id="L182">        dto.setRepeating(transaction.isRepeating());</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        dto.setFrequency(transaction.getFrequency() != null ? transaction.getFrequency().toString() : null);</span>
        
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (transaction.getCategory() != null) {</span>
<span class="fc" id="L186">            dto.setCategoryId(transaction.getCategory().getId());</span>
        }
        
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">        if (transaction.getWallet() != null) {</span>
<span class="fc" id="L190">            dto.setWalletId(transaction.getWallet().getId());</span>
        }
        
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if (transaction.getUser() != null) {</span>
<span class="fc" id="L194">            dto.setUserId(transaction.getUser().getId());</span>
        }
        
<span class="fc" id="L197">        return dto;</span>
    }
    
    @Override
    public Transaction convertToEntity(TransactionDTO dto) {
<span class="fc" id="L202">        Transaction transaction = new Transaction();</span>
<span class="fc" id="L203">        transaction.setId(dto.getId());</span>
<span class="fc" id="L204">        transaction.setName(dto.getName());</span>
<span class="fc" id="L205">        transaction.setAmount(dto.getAmount());</span>
<span class="fc" id="L206">        transaction.setDateOfTransaction(dto.getDateOfTransaction());</span>
<span class="fc" id="L207">        transaction.setRepeating(dto.isRepeating());</span>
        
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (dto.getType() != null) {</span>
            try {
<span class="fc" id="L211">                transaction.setType(TransactionType.valueOf(dto.getType().toUpperCase()));</span>
<span class="nc" id="L212">            } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L213">                throw new RuntimeException(&quot;Invalid transaction type: &quot; + dto.getType());</span>
<span class="fc" id="L214">            }</span>
        }
        
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">        if (dto.getFrequency() != null) {</span>
            try {
<span class="nc" id="L219">                transaction.setFrequency(Frequency.valueOf(dto.getFrequency().toUpperCase()));</span>
<span class="nc" id="L220">            } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L221">                throw new RuntimeException(&quot;Invalid frequency: &quot; + dto.getFrequency());</span>
<span class="nc" id="L222">            }</span>
        }
        
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">        if (dto.getCategoryId() != null) {</span>
<span class="fc" id="L226">            Category category = categoryRepository.findById(dto.getCategoryId()).orElse(null);</span>
<span class="fc" id="L227">            transaction.setCategory(category);</span>
        }
        
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">        if (dto.getWalletId() != null) {</span>
<span class="fc" id="L231">            Wallet wallet = walletRepository.findById(dto.getWalletId()).orElse(null);</span>
<span class="fc" id="L232">            transaction.setWallet(wallet);</span>
        }
        
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">        if (dto.getUserId() != null) {</span>
<span class="fc" id="L236">            User user = userRepository.findById(dto.getUserId()).orElse(null);</span>
<span class="fc" id="L237">            transaction.setUser(user);</span>
        }
        
<span class="fc" id="L240">        return transaction;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>